<!doctype html><html class="not-ready lg:text-base" style=--bg:#faf8f1 lang=zh-cn><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>用树莓派（等）为 USB Midi 键盘增添连接方式 - 🍤 金鱼的记忆仓库</title>
<meta name=theme-color><meta name=description content="我在去年买了一个 M-Audio 的 Midi 键盘，用来连接电脑或者 iPad 弹琴。但是由于琴摆放的位置没有办法拉充电线，所以我能弹琴多久很大程度上取决于设备还有多少电。前一阵子从朋友手里白嫖了个橘子派，鉴于在练琴的时候其实并不需要多高的音质，我决定用这个设备给自己做一个钢琴的音源。
我首先会介绍如何配置 USB Midi 设备发出声音，再介绍如何通过 Midi over BLE 广播 Midi 信号，最后介绍如何通过 Midi over Wifi 来广播 Midi 信号。
系统配置 由于我使用的是橘子派而不是树莓派，我遇到了一些只有这边才会遇到的问题，其他开发板可以选择性掠过本节。
橘子派能安装的最新版本 Armbian 内核关闭了 Midi 功能。在各种论坛研究一圈之后，发现旧版本的 Armbian 内核是开了的，于是我下载了使用旧版内核的系统。
（注意使用旧版本系统仅限于本教程前半部分 USB Midi 设备，假如你需要配置蓝牙 Midi，则必须自己编译新内核。请自己 Google 如何编译 Armbian，在编译选项中开启：Device Drivers > Sound card support > Advanced Linux Sound Architecture > Sequencer Support )
进去之后正常更新系统，旧版镜像要久一点。橘子派还需要在系统中启用声音，使用自带的配置工具 sudo armbian-config，启用 System > Hardware > Toggle hardware configuration > analog-codec 。
由于橘子派会等待网络服务激活后才进入系统，导致开机时间非常长，使用下面的命令关闭它：
sudo systemctl disable NetworkManager-wait-online 你还可以使用 systemd-analyze blame 命令查看服务的启动时间，关闭一些其他你不需要的服务。"><meta name=author content="🍤 金鱼的记忆仓库"><link rel="preload stylesheet" as=style href=https://megabits.xyz/main.min.css><script defer src=https://megabits.xyz/highlight.min.js onload=hljs.initHighlightingOnLoad()></script><link rel=preload as=image href=https://megabits.xyz/theme.png><link rel=preload as=image href=https://megabits.xyz/twitter.svg><link rel=preload as=image href=https://megabits.xyz/github.svg><link rel=preload as=image href=https://megabits.xyz/instagram.svg><link rel=icon href=https://megabits.xyz/favicon.ico><link rel=apple-touch-icon href=https://megabits.xyz/apple-touch-icon.png><meta name=generator content="Hugo 0.124.1"><meta itemprop=name content="用树莓派（等）为 USB Midi 键盘增添连接方式"><meta itemprop=description content="我在去年买了一个 M-Audio 的 Midi 键盘，用来连接电脑或者 iPad 弹琴。但是由于琴摆放的位置没有办法拉充电线，所以我能弹琴多久很大程度上取决于设备还有多少电。前一阵子从朋友手里白嫖了个橘子派，鉴于在练琴的时候其实并不需要多高的音质，我决定用这个设备给自己做一个钢琴的音源。
我首先会介绍如何配置 USB Midi 设备发出声音，再介绍如何通过 Midi over BLE 广播 Midi 信号，最后介绍如何通过 Midi over Wifi 来广播 Midi 信号。
系统配置 由于我使用的是橘子派而不是树莓派，我遇到了一些只有这边才会遇到的问题，其他开发板可以选择性掠过本节。
橘子派能安装的最新版本 Armbian 内核关闭了 Midi 功能。在各种论坛研究一圈之后，发现旧版本的 Armbian 内核是开了的，于是我下载了使用旧版内核的系统。
（注意使用旧版本系统仅限于本教程前半部分 USB Midi 设备，假如你需要配置蓝牙 Midi，则必须自己编译新内核。请自己 Google 如何编译 Armbian，在编译选项中开启：Device Drivers > Sound card support > Advanced Linux Sound Architecture > Sequencer Support )
进去之后正常更新系统，旧版镜像要久一点。橘子派还需要在系统中启用声音，使用自带的配置工具 sudo armbian-config，启用 System > Hardware > Toggle hardware configuration > analog-codec 。
由于橘子派会等待网络服务激活后才进入系统，导致开机时间非常长，使用下面的命令关闭它：
sudo systemctl disable NetworkManager-wait-online 你还可以使用 systemd-analyze blame 命令查看服务的启动时间，关闭一些其他你不需要的服务。"><meta itemprop=datePublished content="2019-08-14T00:00:00+09:00"><meta itemprop=dateModified content="2019-08-14T00:00:00+09:00"><meta itemprop=wordCount content="680"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="用树莓派（等）为 USB Midi 键盘增添连接方式"><meta name=twitter:description content="我在去年买了一个 M-Audio 的 Midi 键盘，用来连接电脑或者 iPad 弹琴。但是由于琴摆放的位置没有办法拉充电线，所以我能弹琴多久很大程度上取决于设备还有多少电。前一阵子从朋友手里白嫖了个橘子派，鉴于在练琴的时候其实并不需要多高的音质，我决定用这个设备给自己做一个钢琴的音源。
我首先会介绍如何配置 USB Midi 设备发出声音，再介绍如何通过 Midi over BLE 广播 Midi 信号，最后介绍如何通过 Midi over Wifi 来广播 Midi 信号。
系统配置 由于我使用的是橘子派而不是树莓派，我遇到了一些只有这边才会遇到的问题，其他开发板可以选择性掠过本节。
橘子派能安装的最新版本 Armbian 内核关闭了 Midi 功能。在各种论坛研究一圈之后，发现旧版本的 Armbian 内核是开了的，于是我下载了使用旧版内核的系统。
（注意使用旧版本系统仅限于本教程前半部分 USB Midi 设备，假如你需要配置蓝牙 Midi，则必须自己编译新内核。请自己 Google 如何编译 Armbian，在编译选项中开启：Device Drivers > Sound card support > Advanced Linux Sound Architecture > Sequencer Support )
进去之后正常更新系统，旧版镜像要久一点。橘子派还需要在系统中启用声音，使用自带的配置工具 sudo armbian-config，启用 System > Hardware > Toggle hardware configuration > analog-codec 。
由于橘子派会等待网络服务激活后才进入系统，导致开机时间非常长，使用下面的命令关闭它：
sudo systemctl disable NetworkManager-wait-online 你还可以使用 systemd-analyze blame 命令查看服务的启动时间，关闭一些其他你不需要的服务。"></head><body class="text-black duration-200 ease-out dark:text-white"><header class="mx-auto flex h-[4.5rem] max-w-3xl px-8 lg:justify-center"><div class="relative z-50 mr-auto flex items-center"><a class="-translate-x-[1px] -translate-y-[1px] text-2xl font-semibold" href=https://megabits.xyz/>🍤 金鱼的记忆仓库</a><div class="btn-dark text-[0] ml-4 h-6 w-6 shrink-0 cursor-pointer [background:url(./theme.png)_left_center/_auto_theme('spacing.6')_no-repeat] [transition:_background-position_0.4s_steps(5)] dark:[background-position:right]" role=button aria-label=Dark></div></div><div class="btn-menu relative z-50 -mr-8 flex h-[4.5rem] w-[5rem] shrink-0 cursor-pointer flex-col items-center justify-center gap-2.5 lg:hidden" role=button aria-label=Menu></div><script>const htmlClass=document.documentElement.classList;setTimeout(()=>{htmlClass.remove("not-ready")},10);const btnMenu=document.querySelector(".btn-menu");btnMenu.addEventListener("click",()=>{htmlClass.toggle("open")});const metaTheme=document.querySelector('meta[name="theme-color"]'),lightBg="#faf8f1".replace(/"/g,""),setDark=e=>{metaTheme.setAttribute("content",e?"#000":lightBg),htmlClass[e?"add":"remove"]("dark"),localStorage.setItem("dark",e)},darkScheme=window.matchMedia("(prefers-color-scheme: dark)");if(htmlClass.contains("dark"))setDark(!0);else{const e=localStorage.getItem("dark");setDark(e?e==="true":darkScheme.matches)}darkScheme.addEventListener("change",e=>{setDark(e.matches)});const btnDark=document.querySelector(".btn-dark");btnDark.addEventListener("click",()=>{setDark(localStorage.getItem("dark")!=="true")})</script><div class="nav-wrapper fixed inset-x-0 top-full z-40 flex h-full select-none flex-col justify-center pb-16 duration-200 dark:bg-black lg:static lg:h-auto lg:flex-row lg:!bg-transparent lg:pb-0 lg:transition-none"><nav class="lg:ml-12 lg:flex lg:flex-row lg:items-center lg:space-x-6"><a class="block text-center text-2xl leading-[5rem] lg:text-base lg:font-normal" href=/dev-posts/>技术文章</a></nav><nav class="mt-12 flex justify-center space-x-10 dark:invert lg:ml-12 lg:mt-0 lg:items-center lg:space-x-6"><a class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6" style=--url:url(./twitter.svg) href=https://twitter.com/Megabits_mzq target=_blank rel=me>twitter
</a><a class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6" style=--url:url(./github.svg) href=https://github.com/megabitsenmzq target=_blank rel=me>github
</a><a class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6" style=--url:url(./instagram.svg) href=https://instagram.com/megabits_mzq target=_blank rel=me>instagram</a></nav></div></header><main class="prose prose-neutral relative mx-auto min-h-[calc(100%-9rem)] max-w-3xl px-8 pb-16 pt-12 dark:prose-invert"><article><header class=mb-16><h1 class="!my-0 pb-2.5">用树莓派（等）为 USB Midi 键盘增添连接方式</h1><div class="text-sm antialiased opacity-60"><time>Aug 14, 2019</time></div></header><section><p>我在去年买了一个 M-Audio 的 Midi 键盘，用来连接电脑或者 iPad 弹琴。但是由于琴摆放的位置没有办法拉充电线，所以我能弹琴多久很大程度上取决于设备还有多少电。前一阵子从朋友手里白嫖了个橘子派，鉴于在练琴的时候其实并不需要多高的音质，我决定用这个设备给自己做一个钢琴的音源。</p><p>我首先会介绍如何配置 USB Midi 设备发出声音，再介绍如何通过 Midi over BLE 广播 Midi 信号，最后介绍如何通过 Midi over Wifi 来广播 Midi 信号。</p><h2 id=系统配置>系统配置</h2><p>由于我使用的是橘子派而不是树莓派，我遇到了一些只有这边才会遇到的问题，其他开发板可以选择性掠过本节。</p><p>橘子派能安装的最新版本 Armbian 内核关闭了 Midi 功能。在各种论坛研究一圈之后，发现旧版本的 Armbian 内核是开了的，于是我下载了使用旧版内核的系统。</p><p>（注意使用旧版本系统仅限于本教程前半部分 USB Midi 设备，假如你需要配置蓝牙 Midi，则必须自己编译新内核。请自己 Google 如何编译 Armbian，在编译选项中开启：Device Drivers > Sound card support > Advanced Linux Sound Architecture > Sequencer Support )</p><p>进去之后正常更新系统，旧版镜像要久一点。橘子派还需要在系统中启用声音，使用自带的配置工具 <code>sudo armbian-config</code>，启用 System > Hardware > Toggle hardware configuration > analog-codec 。</p><p>由于橘子派会等待网络服务激活后才进入系统，导致开机时间非常长，使用下面的命令关闭它：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo systemctl disable NetworkManager-wait-online
</span></span></code></pre></div><p>你还可以使用 <code>systemd-analyze blame</code> 命令查看服务的启动时间，关闭一些其他你不需要的服务。</p><h2 id=安装-fluidsynthhttpwwwfluidsynthorg>安装 <a href=http://www.fluidsynth.org>FluidSynth</a></h2><p>Debian 源中自带的 FluidSynth 版本比较低，是 1.x 的。由于旧版本的 FluidSynth 并不能自动连接 Midi 设备，我们需要手动编译新版。</p><p>为了安装依赖，我们先要调整 apt 源,在文件中取消几个 deb-src 源前面的注释。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo nano /etc/apt/sources.list
</span></span><span style=display:flex><span>sudo apt-get update
</span></span></code></pre></div><p>安装所有需要的依赖包然后编译。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo apt-get build-dep fluidsynth --no-install-recommends
</span></span><span style=display:flex><span>git clone https://github.com/FluidSynth/fluidsynth
</span></span><span style=display:flex><span>cd fluidsynth/
</span></span><span style=display:flex><span>mkdir build
</span></span><span style=display:flex><span>cd build
</span></span><span style=display:flex><span>cmake ..
</span></span><span style=display:flex><span>sudo make install
</span></span></code></pre></div><p>接下来在命令行中执行 fluidsynth 确认是否正常。如果出现了找不到库的情况的话，首先应该尝试更新链接库。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo ldconfig
</span></span></code></pre></div><p>如果这样不行的话，可以添加环境变量。（下面的代码是临时的，永久修改可以自己 Google 一下。）</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>export LD_LIBRARY_PATH<span style=color:#f92672>=</span>/usr/local/lib:$LD_LIBRARY_PATH
</span></span></code></pre></div><p>确认可以正常运行之后就可以进入下一步骤了。</p><p>（本节参阅 <a href=https://github.com/FluidSynth/fluidsynth/wiki/BuildingWithCMake>Github</a>）</p><h2 id=获取-sound-font>获取 Sound Font</h2><p>如果你尝试过直接用 apt 安装 FluidSynth 的话，你应该会看到它推荐的几个包：fluidr3mono-gm-soundfont、timgm6mb-soundfont、fluid-soundfont-gm。这些都是 Sound Font。但是他们可能不够好听，并不能达到你的要求，这时候你就可以去一些第三方网站下载，比如 <a href=https://sites.google.com/site/soundfonts4u/>SoundFont4U</a>。</p><p>FluidSynth 支持 SF2/SF3 格式的音源文件，不支持 SFZ，请注意不要搞错。自己下载的音源可以存到一个叫 sound-fonts 的文件夹下备用，使用 apt 安装的上述几个音源则安装在 /usr/share/sounds/sf2 文件夹下。</p><h2 id=测试声音>测试声音</h2><p>先运行一次测试是否能够正常出声，这里我使用了 GM 音源。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>fluidsynth -is -a alsa -m alsa_seq -g <span style=color:#ae81ff>5</span> -o midi.autoconnect<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> /usr/share/sounds/sf2/FluidR3_GM.sf2
</span></span></code></pre></div><p>解释一下参数：</p><ul><li>a,m 输入输出使用的音频驱动。</li><li>is 作为服务静默运行。</li><li>g 力度阈值，这里设置的大一点，以防一些设备音量太小。</li><li>o 细节参数，这里设置了自动连接 Midi 设备 midi.autoconnect。</li></ul><p>（本节参阅 <a href=https://github.com/FluidSynth/fluidsynth/wiki/UserManual>Github</a>）</p><p>运行之后弹一下连接的键盘，看看有没有声音，比较慢的设备可能需要等一段时间才会显示已连接。按照目前的设置，音量应该会蛮大的，如果声音特别小，可以打开 <code>alsamixer</code> 调整一下音量，并使用 <code>sudo alsactl store</code> 保存状态。确认可以正常演奏之后，就可以进行下一步了。</p><h2 id=fluidsynth-启动服务>FluidSynth 启动服务</h2><p>为了能够让 FluidSynth 开机启动我们需要自己写一个服务：<code>sudo nano /etc/systemd/system/fluidsynth.service</code>。在文件中输入：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-systemd data-lang=systemd><span style=display:flex><span><span style=color:#66d9ef>[Unit]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Description</span><span style=color:#f92672>=</span><span style=color:#e6db74>FluidSynth Daemon</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>After</span><span style=color:#f92672>=</span><span style=color:#e6db74>sound.target</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[Service]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>EnvironmentFile</span><span style=color:#f92672>=</span><span style=color:#e6db74>/etc/fluidsynth</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStart</span><span style=color:#f92672>=</span><span style=color:#e6db74>/usr/local/bin/fluidsynth -is -a alsa -m alsa_seq -z 64 -c 2 -g $GAIN -o synth.cpu-cores=4 -o midi.autoconnect=1 ${FONT_PATH}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[Install]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>WantedBy</span><span style=color:#f92672>=</span><span style=color:#e6db74>multi-user.target</span>
</span></span></code></pre></div><p>解释一下这里多出来的几个参数：</p><ul><li>z 缓存大小，可以使用 64 128 256 等“整数”。</li><li>c 缓存个数，一般为 2 或 3。</li><li>o 多了一个设置 CPU 核心数的选项 synth.cpu-cores，你可以根据自己的开发板来设置。可以装一个 htop 数条条看几个核。</li></ul><p>文件中还把音源文件名和力度放在了环境文件中方便设置。新建环境文件：<code>sudo nano /etc/fluidsynth</code>，在文件中输入：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>FONT_PATH<span style=color:#f92672>=</span>/home/megabits/sound-fonts/SalC5Light2.sf2
</span></span><span style=display:flex><span>GAIN<span style=color:#f92672>=</span>1.5
</span></span></code></pre></div><p>这个应该就不用我太多解释了。这里将力度设置为 1.5 是我试出来在橘子派上比较合适的音量，你可以自己调。假如你的 Midi 键盘有音量滑杆那就更方便了。</p><p>激活服务：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo systemctl enable fluidsynth
</span></span><span style=display:flex><span>sudo systemctl start fluidsynth
</span></span></code></pre></div><p>之后理论上就应该能正常弹琴了。假如听不到声音，可以用 <code>journalctl -u fluidsynth</code> 来查看服务的日志，看看是出了什么问题。如果你只需要用 USB 来连接一下 Midi 设备的话，下面就可以不用看了。</p><p>参考文章：</p><ul><li><a href=http://artteknika.hatenablog.com/entry/2017/04/28/185509>Raspberry Pi Zero をMIDI音源ボックス化</a></li><li><a href=http://hunke.ws/posts/orange-pi-usb-midi-host/>Orange Pi USB MIDI Host</a></li></ul><h2 id=midi-over-bluetooth-low-energy>Midi over Bluetooth Low Energy</h2><p>除了直接用这个做音源，我还有希望能够通过 BLE 转发 USB 设备的 Midi 信号到其他设备上方便连接。首先要下载 BlueZ，由于 BlueZ 默认是没有开启 Midi 功能的，所以需要自己编译。此外这里使用的 BlueZ 是一个经过修改的版本，提供了 Midi Server 的功能。不过这个程序有一个蛮烦人的问题，那就是无法同时发送音符，也就是说弹和弦时候，声音永远都对不齐。所以这个就推荐各位自己考虑一下要不要装吧。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>git clone https://github.com/oxesoft/bluez
</span></span><span style=display:flex><span>sudo apt-get install -y autotools-dev libtool autoconf
</span></span><span style=display:flex><span>sudo apt-get install -y libasound2-dev
</span></span><span style=display:flex><span>sudo apt-get install -y libusb-dev libdbus-1-dev libglib2.0-dev libudev-dev libical-dev libreadline-dev
</span></span><span style=display:flex><span>cd bluez
</span></span><span style=display:flex><span>./bootstrap
</span></span><span style=display:flex><span>./configure --enable-midi
</span></span><span style=display:flex><span>sudo make install
</span></span></code></pre></div><p>之后测试一下开启服务端并用其他支持 Bluetooth Midi 的软件来搜索，如 iOS 下的 Garageband。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo btmidi-server -v -n <span style=color:#e6db74>&#34;Midi over BLE&#34;</span>
</span></span></code></pre></div><p>如果出现了 <code>MGMT_OP_SET_LE failed: Not Supported</code>，就说明设备不支持 BLE。在确认一切正常后打开另外一个终端窗口，连接好 Midi 设备并扫描。注意在这之前要先用别的设备连接上 Bluetooth Midi，BlueZ 只有在有设备连接时才会创建 Midi 通道。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>aconnect -l
</span></span></code></pre></div><p>在列表中找到你自己的蓝牙设备和创建的 &ldquo;Midi over BLE&rdquo;。比如我的输出结果是：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>client 0: <span style=color:#e6db74>&#39;System&#39;</span> <span style=color:#f92672>[</span>type<span style=color:#f92672>=</span>kernel<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0</span> <span style=color:#e6db74>&#39;Timer           &#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>1</span> <span style=color:#e6db74>&#39;Announce        &#39;</span>
</span></span><span style=display:flex><span>client 14: <span style=color:#e6db74>&#39;Midi Through&#39;</span> <span style=color:#f92672>[</span>type<span style=color:#f92672>=</span>kernel<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0</span> <span style=color:#e6db74>&#39;Midi Through Port-0&#39;</span>
</span></span><span style=display:flex><span>client 20: <span style=color:#e6db74>&#39;Keystation 88&#39;</span> <span style=color:#f92672>[</span>type<span style=color:#f92672>=</span>kernel,card<span style=color:#f92672>=</span>1<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0</span> <span style=color:#e6db74>&#39;Keystation 88 MIDI 1&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>1</span> <span style=color:#e6db74>&#39;Keystation 88 MIDI 2&#39;</span>
</span></span><span style=display:flex><span>client 128: <span style=color:#e6db74>&#39;Midi over BLE&#39;</span> <span style=color:#f92672>[</span>type<span style=color:#f92672>=</span>user,pid<span style=color:#f92672>=</span>2104<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0</span> <span style=color:#e6db74>&#39;Midi over BLE   &#39;</span>
</span></span></code></pre></div><p>这里可以看到我的键盘 &ldquo;Keystation 88&rdquo; 编号是 20，&ldquo;Midi over BLE&rdquo; 默认编号是 128。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>aconnect 20:0 128:0 
</span></span></code></pre></div><p>这样就可以把两个通道连接起来了。去键盘上按几个键，看看连接的设备会不会发出声音。一切正常就可以进行下一步了。</p><h2 id=midi-over-ble-启动服务>Midi over BLE 启动服务</h2><p>新建一个服务：<code>sudo nano /lib/systemd/system/btmidi.service</code>，在文件中输入：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-systemd data-lang=systemd><span style=display:flex><span><span style=color:#66d9ef>[Unit]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Description</span><span style=color:#f92672>=</span><span style=color:#e6db74>MIDI Bluetooth connect</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>After</span><span style=color:#f92672>=</span><span style=color:#e6db74>bluetooth.target</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Requires</span><span style=color:#f92672>=</span><span style=color:#e6db74>bluetooth.target</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[Service]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStart</span><span style=color:#f92672>=</span><span style=color:#e6db74>/usr/local/bin/btmidi-server -n &#34;Midi over BLE&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[Install]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>WantedBy</span><span style=color:#f92672>=</span><span style=color:#e6db74>multi-user.target</span>
</span></span></code></pre></div><p>激活服务：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo systemctl enable btmidi.service
</span></span><span style=display:flex><span>sudo systemctl start btmidi.service  
</span></span></code></pre></div><p>接下来配置自动连接 Midi 通道，这里我们使用 udev 来在蓝牙设备发生变化时自动连接。首先来写一个连接脚本：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>touch linkble.sh
</span></span><span style=display:flex><span>chmod a+x linkble.sh
</span></span><span style=display:flex><span>nano linkble.sh
</span></span></code></pre></div><p>在文件中输入：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>/usr/bin/aconnect <span style=color:#e6db74>&#39;Keystation 88&#39;</span>:0 128:0
</span></span></code></pre></div><p>注意这里要把键盘的名字改成自己的。之所以要用设备名来连接，是因为设备编号是不稳定的。接下来建立规则 <code>sudo nano /etc/udev/rules.d/44-bt.rules</code>,在文件中输入：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ACTION<span style=color:#f92672>==</span><span style=color:#e6db74>&#34;add|remove&#34;</span>, SUBSYSTEM<span style=color:#f92672>==</span><span style=color:#e6db74>&#34;bluetooth&#34;</span>, RUN<span style=color:#f92672>+=</span><span style=color:#e6db74>&#34;/home/user-name/linkble.sh&#34;</span>
</span></span></code></pre></div><p>刷新规则：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo udevadm control --reload-rules
</span></span></code></pre></div><p>这样就可以在其他设备连接到 BLE 的时候自动连接通道了。</p><p>参考文章：</p><ul><li><a href=https://neuma.studio/rpi-as-midi-host.html>RASPBERRY PI 3B AS USB/BLUETOOTH MIDI HOST</a></li><li><a href=https://tttapa.github.io/Pages/Ubuntu/Software-Installation/BlueZ.html>BlueZ with MIDI over BLE Support</a></li></ul><h2 id=midi-over-wifi>Midi over Wifi</h2><p>首先需要激活虚拟 Midi 设备模块。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>modprobe snd-virmidi
</span></span><span style=display:flex><span>aconnect -l
</span></span></code></pre></div><p>如果输出中出现了几个虚拟 Midi 设备就说明设置成功了。为了能让模块永久启用，我们来建立一个配置文件 <code>sudo nano /etc/modules-load.d/snd-virmidi.conf</code>，在文件中输入：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>snd-virmidi
</span></span></code></pre></div><p>保存并重启。</p><p>接下来安装 raveloxmidi：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo apt-get install -y git pkg-config libasound2-dev libavahi-client-dev autoconf automake
</span></span><span style=display:flex><span>sudo apt-get install avahi-daemon
</span></span><span style=display:flex><span>git clone -b experimental https://github.com/ravelox/pimidi.git
</span></span><span style=display:flex><span>cd pimidi/raveloxmidi/ <span style=color:#f92672>&amp;&amp;</span> ./autogen.sh <span style=color:#f92672>&amp;&amp;</span> ./configure <span style=color:#f92672>&amp;&amp;</span> make -j2
</span></span><span style=display:flex><span>sudo make install
</span></span></code></pre></div><p>假如你的网络不支持 ipv6，就需要配置一下 avahi-daemon，打开文件：<code>sudo nano /etc/avahi/avahi-daemon.conf</code>，按照下面的值来设置，注意一些行需要取消注释。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>use-ipv6<span style=color:#f92672>=</span>no
</span></span><span style=display:flex><span>publish-addresses<span style=color:#f92672>=</span>yes
</span></span><span style=display:flex><span>publish-aaaa-on-ipv4<span style=color:#f92672>=</span>no
</span></span></code></pre></div><p>接下来查看可用的设备编号：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>amidi -l
</span></span></code></pre></div><p>打开 <code>aconnect -l</code> 来看一下设备在其中的编号，看一下 Midi 键盘的编号和第一个虚拟设备的编号，我的是 28:0 24:0，把它们连接起来。注意这里的顺序，一定是把键盘通道发送给虚拟设备通道。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>aconnect 28:0 24:0
</span></span></code></pre></div><p>我这里第一个虚拟 Midi 设备的编号是 hw:2,0，记住这个值。为 raveloxmidi 建立一个配置文件：<code>/etc/raveloxmidi.conf</code>，在文件中输入：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>alsa.input_device <span style=color:#f92672>=</span> hw:2,0
</span></span><span style=display:flex><span>network.bind_address <span style=color:#f92672>=</span> 0.0.0.0
</span></span><span style=display:flex><span>logging.enabled <span style=color:#f92672>=</span> yes
</span></span><span style=display:flex><span>logging.log_level <span style=color:#f92672>=</span> normal
</span></span></code></pre></div><p>接下来启动测试：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo raveloxmidi -dN -c /etc/raveloxmidi.conf
</span></span></code></pre></div><p>如果程序正常运行了你应该就可以在其他地方连接它。这里以 macOS 上的 Garageband 为例：</p><p>打开 “音频 Midi 音频设置” 并在菜单中打开显示 “Midi 音频工作室”。之后在 “Midi 音频工作室” 的菜单或者工具栏上打开 “Midi 网络设置”。启用 “会话1”。在目录中选择 raveloxmidi，点连接。</p><p>打开 Garageband 弹几个音试一试，如果正常出声就是成功了。</p><h2 id=midi-over-wifi-启动服务>Midi over Wifi 启动服务</h2><p>新建一个服务：<code>sudo nano /etc/systemd/system/raveloxmidi.service</code>，在文件中输入：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-systemd data-lang=systemd><span style=display:flex><span><span style=color:#66d9ef>[Unit]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>After</span><span style=color:#f92672>=</span><span style=color:#e6db74>local-fs.target network.target</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Description</span><span style=color:#f92672>=</span><span style=color:#e6db74>raveloxmidi RTP-MIDI network server</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[Install]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>WantedBy</span><span style=color:#f92672>=</span><span style=color:#e6db74>multi-user.target</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>[Service]</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>User</span><span style=color:#f92672>=</span><span style=color:#e6db74>root</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStartPre</span><span style=color:#f92672>=</span><span style=color:#e6db74>/usr/bin/aconnect &#39;Keystation 88&#39;:0 24:0</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStart</span><span style=color:#f92672>=</span><span style=color:#e6db74>/usr/local/bin/raveloxmidi -dN -c /etc/raveloxmidi.conf</span>
</span></span></code></pre></div><p>注意 Midi 设备的名称要改成自己的。激活服务：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo systemctl enable raveloxmidi.service
</span></span><span style=display:flex><span>sudo systemctl start raveloxmidi.service
</span></span></code></pre></div><p>服务没有启动成功也没关系，可能是因为我们之前已经手动连接过一次 Midi 设备了，重启试试就好。</p><p>（本节参阅：<a href=https://github.com/ravelox/pimidi/blob/master/FAQ.md>Github</a>）</p><p>参考文章：</p><ul><li><a href=https://blog.tarn-vedra.de/pimidi-box/>Using a Raspberry Pi as a RTP-MIDI Gateway for macOS</a></li></ul><h2 id=后记>后记</h2><p>最后我还是没能把这些都装好，新内核老内核都有各自的问题，无法两全。在我重新编译的内核的系统中，虽然两边的程序都能正常运行了，但是 alsa 却开始定时输出一些噪音，非常的诡异。真心推荐大家不要购买 Orange Pi Zero，这个板子很要人命。假如你用的是其他的板子，那按照我的教程来弄应该就可以正常使用了。</p></section></article></main><footer class="opaco mx-auto flex h-[4.5rem] max-w-3xl items-center px-8 text-[0.9em] opacity-60"><div class=mr-auto>&copy; 2024
<a class=link href=https://megabits.xyz/>🍤 金鱼的记忆仓库</a></div><a class="link mx-6" href=https://gohugo.io/ rel=noopener target=_blank>Powered by Hugo️️</a>️
<a class=link href=https://github.com/nanxiaobei/hugo-paper rel=noopener target=_blank>✎ Paper</a></footer></body></html>